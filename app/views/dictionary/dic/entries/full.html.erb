
<div class="workstation-wrapper" data-controller="dic-workstation">

    <%= render 'dictionary/shared/dic_home_links' %>

    <div class="title-article-h1">
      <h1><%= @pali_entry&.name %></h1>
    </div>

    <div class="sub-title-article-h1">
      <h6>Last modified: <%= @index.modified_date.to_date %></h6>
    </div>

    <%# UPPER SECTION %>
    <div class="upper-entry-view"
         data-dic-workstation-target="upperPane"
         data-controller="tabs"
         data-tabs-active-class-value="active-tab"
         style="height: 350px;">

      <%# --- 1. THE BUTTONS (TAB NAV) --- %>
      <nav class="lang-tabs flex-shrink-0">
        <% @grouped_entries.each_with_index do |(lang_code, entries), index| %>
          <%
            lang_labels = { 'pi' => 'Pāḷi', 'en' => 'English', 'lv' => 'Latviešu' }
            label = lang_labels[lang_code] || lang_code.upcase
          %>
          <button data-tabs-target="btn"
                  data-tab-name="lang-<%= lang_code %>"
                  data-action="click->tabs#switch"
                  type="button"
                  <%# If you have an 'active' class, apply it to the first button %>
                  class="p-2 border-0 bg-transparent <%= 'active-tab-style' if index == 0 %>">
            <%= label %> (<%= entries.size %>)
          </button>
        <% end %>
      </nav>

      <%# --- 2. THE CONTENT (PANES) --- %>
      <div class="upper-content-scrollable">
        <% @grouped_entries.each_with_index do |(lang_code, entries), index| %>

          <%# This is the fix: index is now inside the block %>
          <div data-tabs-target="pane"
               data-tab-name="lang-<%= lang_code %>"
               class="<%= 'd-none' unless index == 0 %>">

            <% entries.each do |entry| %>
              <div class="entry-item mb-4">
                <%= render 'entry_main', entry: entry %>
              </div>
            <% end %>
          </div>

        <% end %>
      </div>

    </div>

    <%# SEPARATOR %>
    <div class="dic-v-separator"
         data-action="pointerdown->dic-workstation#beginDictionaryResize">
  <!--    <div class="dic-handle-grip"></div>-->
    </div>

    <%# LOWER SECTION %>
    <div class="lower-evidence-view">
      <div data-controller="tabs"
           data-tabs-active-class-value="active-evidence"
           class="h-100 d-flex flex-column">

        <%# --- TAB NAVIGATION (Fixed at top of lower pane) --- %>
        <nav class="lang-tabs flex-shrink-0">
          <button data-tabs-target="btn" data-tab-name="metadata" data-action="tabs#switch" class="p-2 border-0 bg-transparent">
            Metadata & Notes
          </button>
          <button data-tabs-target="btn" data-tab-name="scans" data-action="tabs#switch" class="p-2 border-0 bg-transparent">
            Manuscript Scans (<%= @index.dic_scans.size %>)
          </button>
          <button data-tabs-target="btn" data-tab-name="audit" data-action="tabs#switch" class="p-2 border-0 bg-transparent">
            History
          </button>
        </nav>

        <%# --- THE COPY BUTTON --- %>
        <button data-action="click->tabs#copyLink" class="btn-copy-link">
          <i class="bi bi-share"></i> Copy Tab Link
        </button>

        <%# --- SCROLLABLE CONTENT AREA --- %>
        <div class="lower-content-scrollable flex-grow-1 overflow-y-auto p-3">

          <%# PANE 1: Metadata (Set as visible by default index == 0 logic if needed) %>
          <div data-tabs-target="pane" data-tab-name="metadata">
            <%= render partial: 'metadata_index', locals: { scans: @index } %>
          </div>

          <%# PANE 2: Scans %>
          <div data-tabs-target="pane" data-tab-name="scans" class="d-none">
            <% if @index.dic_scans.any? %>
              <%= render partial: 'scans', locals: { scans: @index.dic_scans } %>
            <% end %>
          </div>

          <%# PANE 3: Audit %>
          <div data-tabs-target="pane" data-tab-name="audit" class="d-none">
            <%= render 'audit_history' %>
          </div>

        </div>
      </div>
    </div>

</div>

